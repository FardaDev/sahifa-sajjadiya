name: Deploy

on:
  workflow_run:
    workflows: ["CI Checks"]
    types:
      - completed
    branches:
      - main
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  deploy:
    name: Deploy to ${{ github.event_name == 'workflow_dispatch' && inputs.environment || (github.event.workflow_run.head_branch == 'main' && 'production' || 'staging') }}
    runs-on: ubuntu-latest

    # Only run if CI passed (for workflow_run) or manually triggered
    if: |
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}

      # === Production Deploy ===
      - name: Deploy to Production
        if: |
          (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'main') ||
          (github.event_name == 'workflow_dispatch' && inputs.environment == 'production')
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.PASSWORD }}
          port: ${{ secrets.PORT }}
          script: |
            cd /home/ubuntu/ez-docker-for-laravel
            sudo ./ez laravel deploy androadmin production

      # === Staging Deploy ===
      - name: Deploy to Staging
        if: |
          (github.event_name == 'workflow_run' && github.event.workflow_run.head_branch == 'staging') ||
          (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging')
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          password: ${{ secrets.STAGING_PASSWORD }}
          port: ${{ secrets.STAGING_PORT }}
          script: |
            cd /home/ubuntu/ez-docker-for-laravel
            sudo ./ez laravel deploy androadmin staging

      # === Dev Deploy (Manual Only) ===
      - name: Deploy to Dev
        if: github.event_name == 'workflow_dispatch' && inputs.environment == 'dev'
        uses: appleboy/ssh-action@v1.2.3
        with:
          host: ${{ secrets.DEV_HOST }}
          username: ${{ secrets.DEV_USER }}
          password: ${{ secrets.DEV_PASSWORD }}
          port: ${{ secrets.DEV_PORT }}
          script: |
            cd /home/ubuntu/ez-docker-for-laravel
            sudo ./ez laravel deploy androadmin dev
